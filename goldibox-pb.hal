#!/usr/bin/env halrun
# ################################################
#
# Goldibox PocketBeagle HAL configuration
#
# http://linuxcnc.org/docs/devel/html/man/man1/halcmd.1.html
#
# ################################################
# Load and plumb comps
# ################################################

# ################
# Thermistor
# - 10k thermistor on AIN5 with 1k pull-up resistor
#     https://github.com/machinekit/machinekit/blob/master/src/hal/user_comps/hal_temp_bbb.py

# - Load thermistor comp
loadusr -Wn therm hal_temp_bbb -n therm -c 00:TR91,01:TR91 -b CRAMPS -r 1000
# - Internal temp signal
net temp-int                        <= therm.ch-00.value
net temp-ext                        <= therm.ch-01.value

# ################
# Threads

# - One slow thread
loadrt threads name1=servo-thread period1=10000000

# ################
# PocketBeagle GPIOs
#     http://linuxcnc.org/docs/devel/html/man/man9/hal_bb_gpio.9.html
# - pinouts
#     http://beagleboard.org/support/bone101

loadrt hal_bb_gpio board=PocketBeagle output_pins=102,104,106,108,110,112,120
addf bb_gpio.read                   servo-thread
addf bb_gpio.write                  servo-thread

# - Enable
net enable                          => bb_gpio.p1.out-06

# - Peltier heat/cool
net cool-on                         => bb_gpio.p1.out-02
net heat-on                         => bb_gpio.p1.out-04

# - Fan
net switch-on                       => bb_gpio.p1.out-20

# - LEDs
net led-heat                        => bb_gpio.p1.out-08
net led-status                      => bb_gpio.p1.out-10
net led-cool                        => bb_gpio.p1.out-12

# ################################################
# Load common HAL config
# ################################################

source goldibox-common.hal
